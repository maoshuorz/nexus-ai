# Nexus AI 实时监控模块架构决策文档

**决策人:** CEO Alex  
**决策时间:** 2026-02-18 08:50  
**文档版本:** v1.0

---

## 一、战略决策声明

### 1.1 战略定位决策

**决策: 内部管理工具 + 客户展示窗口（双定位）**

**理由:**
- **客户展示价值:** 实时Agent协作、项目进度透明度能极大增强客户信任
- **内部管理刚需:** 作为CEO，我需要实时掌握收入、项目、Agent状态
- **差异化竞争:** 市面上没有展示AI Agent实时工作的监控系统
- **技术可行性:** 基于现有monitor_v4.html和stage_monitor_v2.html可以快速迭代

**执行策略:**
- 开发两个版本：公开版（客户可见）+ 完整版（内部管理）
- 公开版隐藏敏感财务数据和内部讨论
- 完整版增加财务、Agent对话、Gmail接单等敏感信息

### 1.2 核心指标优先级（P0-P2分级）

**P0 - 最关键指标（必须实时监控）**
| 指标 | 数据来源 | 更新频率 | 告警阈值 |
|------|---------|---------|---------|
| 本月收入 | orders.json + Gmail系统 | 实时 | < $5,000/月 |
| 本月净利润 | CFO计算 | 每小时 | 利润率 < 30% |
| 进行中的项目数 | orders.json | 实时 | > 5个（资源预警）|
| Agent在线状态 | 心跳检测 | 每5分钟 | 任何Agent离线 |

**P1 - 重要指标（每小时更新）**
| 指标 | 数据来源 | 用途 |
|------|---------|------|
| 新客户咨询数 | Gmail系统 | 营销效果评估 |
| 项目完成率 | orders.json | 交付能力评估 |
| Agent任务负载 | 任务分配系统 | 资源均衡 |
| 系统运行时间 | 监控服务 | 稳定性评估 |

**P2 - 参考指标（每日更新）**
| 指标 | 数据来源 |
|------|---------|
| 客户满意度 | 邮件反馈 |
| Agent工作效率 | 任务完成时间 |
| 代码提交频率 | GitHub API |
| 网站访问量 | Google Analytics |

### 1.3 技术方案决策

**决策: 方案 B - 轻量级后端服务（Python FastAPI）**

**选择理由:**

| 评估维度 | A. 静态JSON | **B. FastAPI** | C. 第三方工具 |
|---------|------------|---------------|--------------|
| 实时性 | ❌ 差（需定时生成）| ✅ 实时API | ⚠️ 受限 |
| 数据整合 | ❌ 困难 | ✅ 灵活 | ⚠️ 需适配 |
| 成本 | ✅ 免费 | ✅ 免费（自托管）| ❌ 付费 |
| 定制性 | ⚠️ 有限 | ✅ 完全可控 | ❌ 受限 |
| 扩展性 | ❌ 差 | ✅ 良好 | ⚠️ 中等 |
| 开发时间 | ✅ 1天 | ⚠️ 3天 | ✅ 1天 |

**具体技术栈:**
```
后端: Python FastAPI + Uvicorn
数据存储: JSON文件（阶段1）→ SQLite（阶段2）
前端: 现有HTML + TailwindCSS + Vanilla JS
部署: GitHub Pages（前端）+ Render/Railway（后端免费版）
实时通信: Server-Sent Events (SSE) 或 轮询（阶段1）
```

**阶段化实施:**
- **阶段1 (本周):** FastAPI基础API + 轮询更新 + JSON数据存储
- **阶段2 (下周):** WebSocket实时推送 + SQLite数据库
- **阶段3 (月内):** 权限控制 + 历史数据分析

---

## 二、任务分配表

### 2.1 任务总览

| Agent | 核心任务 | 截止时间 | 验收标准 |
|-------|---------|---------|---------|
| **CTO David** | FastAPI后端服务 + API设计 | 2026-02-19 18:00 | API文档完整，所有P0指标可查询 |
| **CPO Michael** | 监控页面UI/UX重构 + 双版本设计 | 2026-02-19 20:00 | 公开版+完整版设计稿，响应式布局 |
| **COO Emma** | Gmail数据接入 + orders.json整合 | 2026-02-19 16:00 | 邮件自动写入orders.json，实时同步 |

### 2.2 详细任务清单

#### CTO David - 技术架构与实现

**任务1: FastAPI后端服务搭建**
- [ ] 创建 monitor_backend/ 目录结构
- [ ] 实现 FastAPI 基础框架
- [ ] 配置 CORS 允许前端访问
- [ ] 设计 RESTful API 路由

**任务2: API 端点开发**
```python
# 必需端点
GET  /api/v1/metrics          # 获取所有关键指标
GET  /api/v1/agents           # 获取Agent状态
GET  /api/v1/projects         # 获取项目列表
GET  /api/v1/finance          # 获取财务数据
POST /api/v1/webhook/gmail    # Gmail系统回调接口
```

**任务3: 数据层实现**
- [ ] 读取 orders.json 并提供API
- [ ] 实现内存缓存减少磁盘IO
- [ ] 添加数据验证和错误处理

**任务4: 部署配置**
- [ ] 创建 requirements.txt
- [ ] 配置 Render/Railway 部署
- [ ] 编写 Dockerfile（可选）

**验收标准:**
1. API响应时间 < 200ms
2. 所有P0指标可通过API获取
3. 包含API文档（自动生成的Swagger UI）
4. 代码推送到 GitHub

---

#### CPO Michael - UI/UX设计和前端开发

**任务1: 双版本设计规划**
- [ ] 公开版设计（客户可见）
  - 展示：项目进度、Agent工作状态、客户案例
  - 隐藏：财务数据、内部讨论、成本信息
- [ ] 完整版设计（内部管理）
  - 增加：收入/利润面板、Agent对话日志、Gmail接单状态

**任务2: 监控页面重构**
- [ ] 基于 monitor_v4.html 改进
- [ ] 整合 stage_monitor_v2.html 的Agent通信可视化
- [ ] 新增财务监控面板
- [ ] 实现响应式布局（移动端适配）

**任务3: 数据可视化组件**
- [ ] 收入趋势图表（Chart.js）
- [ ] 项目进度甘特图
- [ ] Agent负载仪表盘
- [ ] 实时活动日志流

**任务4: 前端数据对接**
- [ ] 实现 API 调用封装
- [ ] 添加自动刷新（每30秒）
- [ ] 离线状态提示
- [ ] 加载状态优化

**交付物:**
1. monitor_public.html - 公开版监控页面
2. monitor_internal.html - 完整版监控页面
3. assets/monitor.css - 共享样式
4. assets/monitor.js - 共享脚本

---

#### COO Emma - 数据接入与整合

**任务1: Gmail数据提取增强**
- [ ] 修改 gmail_auto_order.py
- [ ] 提取邮件中的关键信息（客户名、需求类型、预算）
- [ ] 实现邮件分类：咨询/报价/订单/垃圾

**任务2: orders.json 自动化**
- [ ] 创建数据写入模块
- [ ] 新邮件自动转换为订单记录
- [ ] 实现订单状态流转（new → evaluating → accepted → in_progress → completed）
- [ ] 添加时间戳和ID生成

**任务3: 数据同步机制**
- [ ] 设计数据格式规范
```json
{
  "id": "ORD-20260218-001",
  "timestamp": "2026-02-18T08:30:00Z",
  "source": "gmail",
  "type": "inquiry|quote|order|support",
  "status": "new|evaluating|accepted|in_progress|completed|cancelled",
  "client": {
    "name": "",
    "email": "",
    "company": ""
  },
  "project": {
    "title": "",
    "description": "",
    "budget": 0,
    "currency": "USD"
  },
  "assigned_to": ["agent_id"],
  "timeline": {
    "created": "",
    "started": "",
    "completed": ""
  },
  "revenue": {
    "quoted": 0,
    "actual": 0
  }
}
```

**任务4: 测试与验证**
- [ ] 使用测试邮件验证数据提取
- [ ] 验证订单状态转换逻辑
- [ ] 确保数据不丢失

**验收标准:**
1. 新邮件5分钟内出现在orders.json
2. 数据格式符合规范
3. 支持至少100个订单记录
4. 备份机制防止数据丢失

---

## 三、技术架构简述

### 3.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户层 (Users)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   客户        │  │  CEO/管理层   │  │   Agent     │          │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
└─────────┼─────────────────┼─────────────────┼──────────────────┘
          │                 │                 │
          ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                      展示层 (Presentation)                       │
│  ┌──────────────────┐      ┌──────────────────┐                │
│  │ monitor_public   │      │ monitor_internal │                │
│  │ (GitHub Pages)   │      │ (内部部署)        │                │
│  └────────┬─────────┘      └────────┬─────────┘                │
└───────────┼─────────────────────────┼──────────────────────────┘
            │                         │
            └──────────┬──────────────┘
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                      API层 (API Gateway)                         │
│              FastAPI Service (Render/Railway)                   │
│  ┌────────────┬────────────┬────────────┬────────────┐         │
│  │ /metrics   │ /agents    │ /projects  │ /finance   │         │
│  └─────┬──────┴─────┬──────┴─────┬──────┴─────┬──────┘         │
└────────┼────────────┼────────────┼────────────┼────────────────┘
         │            │            │            │
         ▼            ▼            ▼            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据层 (Data Layer)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ orders.json  │  │ agent_status │  │ financial    │          │
│  │ (项目数据)    │  │ (Agent状态)   │  │ (财务计算)    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
         ▲
         │
┌─────────────────────────────────────────────────────────────────┐
│                      接入层 (Integration)                        │
│  ┌──────────────────────────────────────────────┐              │
│  │         gmail_auto_order.py                   │              │
│  │  (Gmail监控 → 邮件解析 → 订单生成 → 写入JSON)  │              │
│  └──────────────────────────────────────────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 数据流说明

```
┌─────────┐     ┌─────────────┐     ┌─────────────┐     ┌──────────┐
│  Gmail  │────▶│  邮件解析    │────▶│ orders.json │────▶│ FastAPI  │
│  新邮件  │     │  自动分类    │     │   数据文件   │     │   API    │
└─────────┘     └─────────────┘     └─────────────┘     └────┬─────┘
                                                             │
                              ┌──────────────────────────────┘
                              ▼
                    ┌──────────────────┐
                    │ 监控页面 (JS轮询) │
                    │ 每30秒刷新数据    │
                    └──────────────────┘
```

### 3.3 关键设计决策

**1. 为什么选择JSON而非数据库（阶段1）**
- 快速迭代，无需数据库迁移
- 与Git版本控制结合，数据变更可追踪
- 部署简单，无需数据库服务器
- 阶段2会迁移到SQLite

**2. 实时更新机制**
- 阶段1: 前端轮询（30秒间隔）
- 阶段2: WebSocket推送（Agent状态实时更新）
- 权衡: 轮询实现简单，WebSocket需要更多开发时间

**3. 安全性设计**
- 公开版部署在GitHub Pages（完全静态）
- 完整版内部部署（通过VPN/内网访问）
- API增加简单的Token验证（阶段1可暂不使用）

---

## 四、项目时间线

```
2026-02-18 (今天)
├── 08:50 CEO Alex 发布决策文档 ✅
├── 09:00 各Agent开始执行任务
├── 16:00 COO Emma 数据接入完成
├── 18:00 CTO David 后端API完成
└── 20:00 CPO Michael 前端页面完成

2026-02-19 (明天)
├── 09:00 集成测试
├── 14:00 Bug修复
├── 16:00 部署上线
└── 18:00 发布监控模块v1.0

2026-02-20 (后天)
└── 收集反馈，规划v1.1
```

---

## 五、风险评估与应对

| 风险 | 可能性 | 影响 | 应对措施 |
|------|-------|------|---------|
| Gmail API限制 | 中 | 高 | 实现请求限速和重试机制 |
| 数据竞争（同时写入） | 中 | 高 | 使用文件锁或队列机制 |
| 前端API跨域问题 | 低 | 中 | FastAPI配置CORS白名单 |
| 部署平台限制 | 低 | 中 | 准备备选部署方案 |

---

## 六、附录

### A. API响应示例

**GET /api/v1/metrics**
```json
{
  "revenue": {
    "month_to_date": 15000,
    "target": 10000,
    "currency": "USD"
  },
  "projects": {
    "active": 2,
    "completed_this_month": 3,
    "pending": 5
  },
  "agents": {
    "online": 6,
    "total": 6,
    "status": {
      "ceo": "active",
      "cmo": "active",
      "cto": "active",
      "cfo": "active",
      "cpo": "active",
      "coo": "active"
    }
  },
  "last_updated": "2026-02-18T08:50:00Z"
}
```

### B. 监控页面路由规划

| 页面 | 路径 | 访问权限 |
|------|------|---------|
| 公开监控 | /monitor.html | 公开 |
| 内部监控 | /internal/monitor.html | 内部 |
| API文档 | /docs | 开发 |

---

**决策批准:** CEO Alex  
**执行开始:** 2026-02-18 09:00

*此文档为Nexus AI监控模块开发的最高指导文件，所有Agent必须严格遵循。*
